name: RustDesk Pro Session

on:
  workflow_dispatch:

jobs:
  rustdesk-session:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ====================================================
      # 1. تحميل وتثبيت RustDesk
      # ====================================================
      - name: Install RustDesk
        run: |
          Write-Host "Downloading RustDesk..."
          $url = "https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-x86_64.exe"
          $output = "$env:TEMP\rustdesk.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          
          Write-Host "Installing..."
          # تسمية الملف باسم مختلف لتجنب التعارض
          Copy-Item $output -Destination "$env:ProgramFiles\RustDesk\RustDesk.exe" -Force -ErrorAction SilentlyContinue
          
          # خدعة المطورين: تشغيل الخدمة بصمت
          Start-Process -FilePath "$output" -ArgumentList "--silent-install" -Verb RunAs -Wait
          
          Write-Host "RustDesk Installed Successfully."

      # ====================================================
      # 2. توليد البيانات وحفظها (الجزء الذكي)
      # ====================================================
      - name: Config & Generate Credentials
        id: creds
        run: |
          $path = "C:\Program Files\RustDesk\RustDesk.exe"
          
          # 1. ضبط كلمة مرور ثابتة من اختيارك
          $MyPassword = "Zxxz4444"
          & $path --password $MyPassword
          
          # 2. استخراج الـ ID الخاص بالجهاز
          # ننتظر قليلاً حتى تعمل الخدمة وتولد ID
          Start-Sleep -Seconds 10
          $RustDeskID = & $path --get-id
          
          if (-not $RustDeskID) {
              Write-Error "Failed to get ID. Service might not be ready."
              # محاولة ثانية
              Start-Sleep -Seconds 5
              $RustDeskID = & $path --get-id
          }

          Write-Host "=========================================="
          Write-Host "ID: $RustDeskID"
          Write-Host "Password: $MyPassword"
          Write-Host "=========================================="
          
          # 3. حفظ المعلومات في ملف نصي
          $Content = "RustDesk ID: $RustDeskID`nPassword: $MyPassword"
          $Content | Out-File -FilePath "rustdesk_login.txt"

      # ====================================================
      # 3. رفع ملف البيانات (Artifact)
      # ====================================================
      - name: Upload Login Details
        uses: actions/upload-artifact@v4
        with:
          name: RustDesk-Login-Info
          path: rustdesk_login.txt

      # ====================================================
      # 4. إبقاء الجلسة تعمل
      # ====================================================
      - name: Keep Session Alive
        run: |
          Write-Host "Session is running..."
          Write-Host "Go to 'Summary' page and download 'RustDesk-Login-Info' to get your ID."
          $KeepAliveMinutes = 350
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt $KeepAliveMinutes) {
            Start-Sleep -Seconds 60
          }
