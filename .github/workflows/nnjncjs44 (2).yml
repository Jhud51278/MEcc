name: macOS VNC Session (High Cost Warning)

on:
  workflow_dispatch:

jobs:
  macos-session:
    runs-on: macos-13 # نستخدم Ventura لأنه أخف وأسرع من latest حالياً
    timeout-minutes: 60 # وضعت حداً أقصى ساعة واحدة لحماية حسابك (تساوي 600 دقيقة خصم)

    env:
      # ====================================================
      # ضع كود Base64 المشفر هنا
      # ====================================================
      aa1: "ضع_الكود_المشفر_هنا"
      
      # كلمة مرور المستخدم (يجب أن تكون قوية)
      VNC_PASS: "MacPass1234!"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ====================================================
      # 1. تثبيت وتشغيل Tailscale
      # ====================================================
      - name: Install & Connect Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install tailscale
          
          # تشغيل الخدمة في الخلفية
          sudo brew services start tailscale
          sleep 5
          
          # فك التشفير
          ENCODED=$aa1
          if [ -z "$ENCODED" ]; then echo "Error: Key is empty"; exit 1; fi
          
          # فك التشفير في الماك يتم بـ base64 -D
          REAL_KEY=$(echo "$ENCODED" | base64 -d | xargs)
          
          # الاتصال
          echo "Connecting to Tailscale..."
          sudo tailscale up --authkey=$REAL_KEY --hostname="Mac-Runner-$GITHUB_RUN_NUMBER" --ssh
          
          # الحصول على IP
          TS_IP=$(tailscale ip -4)
          echo "✅ Connected! Tailscale IP: $TS_IP"

      # ====================================================
      # 2. إعداد المستخدم وتفعيل VNC
      # ====================================================
      - name: Setup VNC & User
        run: |
          echo "Setting password for user 'runner'..."
          # تغيير كلمة سر المستخدم الحالي
          echo "runner:$VNC_PASS" | sudo chpasswd
          
          echo "Enabling Apple Remote Desktop (VNC)..."
          # أمر سحري لتفعيل التحكم عن بعد في الماك
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASS" \
          -restart -agent -privs -all
          
          echo "✅ VNC Enabled on IP: $(tailscale ip -4)"
          echo "✅ Username: runner"
          echo "✅ Password: $VNC_PASS"

      # ====================================================
      # 3. إبقاء الجلسة (Keep Alive)
      # ====================================================
      - name: Keep Session Alive
        run: |
          echo "Session Started. Connect using VNC Viewer."
          echo "Target: $(tailscale ip -4)"
          echo "Do NOT keep this running for long! (Expensive)"
          
          # حلقة لا نهائية لإبقاء الجلسة
          while true; do sleep 60; done
