name: macOS VNC Final (New User)

on:
  workflow_dispatch:

jobs:
  macos-session:
    runs-on: macos-latest
    timeout-minutes: 60

    env:
      # Ø¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø´ÙØ± Ù‡Ù†Ø§
      aa1: "dHNrZXktYXV0aC1rc2JSdEZKZDJ0MTFDTlRSTC1yWlk4SjF2SGdZZ3Q4N0NQanFFQ1lnM0ZFMTFGTU1XQlI="
      
      # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø³Ù†Ù†Ø´Ø¦Ù‡
      NEW_USER: "adminuser"
      NEW_PASS: "MacPass1234!"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ====================================================
      # 1. ØªØ´ØºÙŠÙ„ Tailscale
      # ====================================================
      - name: Install & Connect Tailscale
        run: |
          brew install tailscale
          sudo brew services start tailscale
          sleep 5
          
          # ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
          ENCODED=$aa1
          if [ -z "$ENCODED" ]; then echo "Error: Key is empty"; exit 1; fi
          REAL_KEY=$(echo "$ENCODED" | base64 -d | xargs)
          
          # Ø§Ù„Ø§ØªØµØ§Ù„
          sudo tailscale up --authkey=$REAL_KEY --hostname="Mac-Action" --ssh
          echo "âœ… Tailscale IP: $(tailscale ip -4)"

      # ====================================================
      # 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØµØ±ÙŠØ­)
      # ====================================================
      - name: Create Admin User & Enable VNC
        run: |
          echo "Creating new admin user: $NEW_USER ..."
          
          # Ø£Ù…Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ø¯Ù…Ù†
          sudo sysadminctl -addUser $NEW_USER -fullName "Admin User" -password "$NEW_PASS" -admin
          
          echo "Enabling VNC for $NEW_USER ..."
          # ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$NEW_PASS" \
          -restart -agent -privs -all
          
          echo "âœ… User Created Successfully!"

      # ====================================================
      # 3. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
      # ====================================================
      - name: Keep Session Alive
        run: |
          IP=$(tailscale ip -4)
          echo "==================================================="
          echo "ğŸš€ READY TO CONNECT!"
          echo "1. Make sure Tailscale is connected on YOUR PC."
          echo "2. Open VNC Viewer."
          echo "3. Connect to IP: $IP"
          echo "---------------------------------------------------"
          echo "ğŸ‘¤ Username: $NEW_USER"
          echo "ğŸ”‘ Password: $NEW_PASS"
          echo "==================================================="
          
          # Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
          while true; do sleep 60; done
