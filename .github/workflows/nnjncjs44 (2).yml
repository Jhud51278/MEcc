name: macOS Intel VNC (Stable Display)

on:
  workflow_dispatch:

jobs:
  macos-session:
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø³Ø®Ø© 12 Ù„Ø£Ù†Ù‡Ø§ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Intel ÙˆØªØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ ÙÙŠ M1/M2
    runs-on: macos-12
    timeout-minutes: 60

    env:
      aa1: "dHNrZXktYXV0aC1rc2JSdEZKZDJ0MTFDTlRSTC1yWlk4SjF2SGdZZ3Q4N0NQanFFQ1lnM0ZFMTFGTU1XQlI="
      NEW_USER: "adminuser"
      NEW_PASS: "zxxz1234"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. ØªØ´ØºÙŠÙ„ Tailscale
      - name: Install & Connect Tailscale
        run: |
          brew install tailscale
          sudo brew services start tailscale
          sleep 5
          
          ENCODED=$aa1
          if [ -z "$ENCODED" ]; then echo "Error: Key is empty"; exit 1; fi
          REAL_KEY=$(echo "$ENCODED" | base64 -d | xargs)
          
          # Ø§Ù„Ø§ØªØµØ§Ù„
          sudo tailscale up --authkey=$REAL_KEY --hostname="Mac-Intel-Display" --ssh
          echo "âœ… Tailscale IP: $(tailscale ip -4)"

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªÙØ¹ÙŠÙ„ VNC
      - name: Setup User & VNC
        run: |
          echo "Creating user..."
          sudo sysadminctl -addUser $NEW_USER -fullName "Admin User" -password "$NEW_PASS" -admin
          
          echo "Configuring VNC..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$NEW_PASS" \
          -restart -agent -privs -all
          
          # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ Intel/macOS 12)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser -string "$NEW_USER"
          
          echo "âœ… Ready!"

      # 3. Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
      - name: Keep Session Alive
        run: |
          IP=$(tailscale ip -4)
          echo "==================================================="
          echo "ğŸš€ CONNECT NOW!"
          echo "IP: $IP"
          echo "Username: $NEW_USER"
          echo "Password: $NEW_PASS"
          echo "==================================================="
          
          while true; do sleep 60; done
